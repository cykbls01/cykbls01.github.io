---
layout:     post
title:      MongoDB系列总结3
subtitle:   MongoDB基础知识
date:       2021-11-14
author:     Yikun Chen
header-img: img/background/header.png
catalog: true
tags:
    - mongodb

---


# MongoDB系列总结3

MongoDB基础知识
--

## 基本简介

MongoDB是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。MongoDB是一个介于关系数据库和非关系数据库(nosql)之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。

## 基本概念

### 数据库概念对比

|  mysql  | mongodb |
|  ----  | ----  |
| table | collection |
| row | document |
| column | field |

更直观的对比图

![picture1](/img/mongodb/database.png)

### 索引

Mongodb 的索引使用的 B-tree 这一特殊的数据结构，借助索引 Mongodb 可以高效的匹配到需要查询的数据。

![picture1](/img/mongodb/index.png)

Single field index

Single field index 是 Mongodb 最简单的索引类型。

![picture1](/img/mongodb/index1.png)

Compound index

Mongodb 支持对多个 field 建立索引，称之为 compound index。Compound index 中 field 的顺序对索引的性能有至关重要的影响，比如索引 {userid:1, score:-1} 首先根据 userid 排序，然后再在每个 userid 中根据 score 排序。

![picture1](/img/mongodb/index2.png)

## 集群

复制提供了冗余并增加了 [数据可用性](https://docs.mongodb.com/manual/reference/glossary/#term-high-availability)。对于不同数据库服务器上的多个数据副本，复制为防止单台数据库服务器故障提供了一定程度的容错能力。在某些情况下，复制可以提高读取性能，因为客户端可以将读操作发送到不同的服务器上。在不同的数据中心维护数据副本可以提高分布式应用程序的数据本地化和可用性。您还可以维护额外的副本以实现特殊用途，比如灾难恢复、报告或备份。

### 节点类型

#### 主节点

主节点是唯一一个可以接受写操作的成员。MongoDB在主节点 上应用写操作，然后将这些操作记录到主节点的oplog中。从节点成员复制这个日志然后应用到它们的数据集中。在下图的三成员副本集中，主节点接受所有写操作。然后从节点复制oplog应用至它们的数据集中。副本集所有的成员都可以接受读操作。但是，默认情况下，应用程序会将其读操作定向至主节点。副本集最多有一个主节点。 如果当前主节点不可用，一个选举会抉择出新的主节点。

![picture1](/img/mongodb/replica.svg)

#### 从节点

一个从节点维护了主节点数据集的一个副本。为了复制数据，从节点通过异步的方式将主节点oplog 应用至自己的数据集中。一个副本集可以有一个或多个从节点。虽然客户端不能将数据写入到从节点，但客户端可以由从节点读取数据。从节点可以成为主节点。如果当前主节点不可用，副本集会发起选举来选择哪个从节点成为新的主节点。您可以出于特殊目的来配置从节点成员。您可以配置一个从节点用于:阻止它在选举中成为主节点，适用于将该节点部署在备用数据中心或者充当一个冷备节点。防止应用程序从它读取数据，适用于在该节点上运行需要与正常流量分离的应用程序。保持一个运行的“历史”快照，以便在从某些错误恢复时使用。

#### 仲裁节点

在某些情况下（例如有一个主节点和一个从节点，但由于成本约束无法添加另一个从节点），你可以在副本集中添加一个仲裁节点。仲裁节点没有数据集的副本，并且不能成为主节点。然而，仲裁节点可以参与主节点选举。一个仲裁节点只有 1 票选举权。

### 日志

oplog(操作日志)是一个特殊的有限集合，它对数据库中所存储数据的所有修改操作进行滚动记录。MongoDB在主节点上应用数据库操作，然后将这些操作记录到主节点的oplog上。然后从节点成员会以异步的方式复制并应用这些操作。所有副本集成员都包含一个oplog的副本，其位于local.oplog.rs 集合中，该集合可以让副本集成员维护数据库的当前状态。为了便于复制，所有副本集成员将心跳发送给所有其他成员。任何从节点成员都可以从任何其他成员导入oplog条目。oplog中的每个操作都是幂等的。也就是说，对目标数据集应用一次或多次oplog操作都会产生相同的结果。

### 数据同步

#### 初始化同步
克隆除local数据库之外的所有数据库。为了进行克隆，mongod 扫描每个源数据库中的各个集合，并将所有数据插入到这些集合各自的副本中。
初始化同步在为每个集合复制文档时会建立集合的所有索引。初始化同步会获取在数据复制期间新增的oplog记录。请确保目标成员的local 数据库中有足够的磁盘空间，以便可以在数据复制阶段期间内临时存储这些oplog记录。
对数据集应用所有的更改。使用来自源库的oplog，mongod 更新其数据集以反映副本集的当前状态。当初始化同步完成后，目标成员会从 STARTUP2状态转为SECONDARY状态。

#### 复制数据

从节点成员在初始化同步之后会不断地复制数据。从节点成员从同步源复制oplog ，并以异步的方式应用这些操作 。从节点可以根据ping时间和其他成员复制状态的变化，按需来自动调整它们的同步源。从节点会避免从延迟成员和隐藏成员中同步数据。
MongoDB通过使用多线程批量应用写操作来提高并发。MongoDB根据文档id （WiredTiger）进行分批，同时使用不同的线程应用每组操作。MongoDB总是按照原始的写顺序对给定的文档应用写操作。

### 副本集成员

一个副本集至多可以有50个成员，但可投票成员最多只能有7个。如果副本集已经有7个有投票权的成员了，那其他的成员只能作为无投票权成员。


参考文献
--