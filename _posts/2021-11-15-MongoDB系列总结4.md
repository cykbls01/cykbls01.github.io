---
layout:     post
title:      MongoDB系列总结4
subtitle:   MongoDB进阶知识
date:       2021-11-14
author:     Yikun Chen
header-img: img/background/header.png
catalog: true
tags:
    - mongodb

---


# MongoDB系列总结4

MongoDB进阶知识
--

## 集群分片

分片是一种将数据分配到多个机器上的方法。MongoDB通过分片技术来支持具有海量数据集和高吞吐量操作的部署方案。数据库系统的数据集或应用的吞吐量比较大的情况下，会给单台服务器的处理能力带来极大的挑战。例如，高查询率会耗尽服务器的CPU资源。工作的数据集大于系统的内存压力、磁盘驱动器的I/O容量。MongoDB通过分片来实现水平扩展。

### 分片集群

MongoDB分片集群包括以下组件：

分片：每个shard（分片）包含被分片的数据集中的一个子集。每个分片可以被部署为副本集架构。

mongos：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。

config servers：config servers存储了分片集群的元数据和配置信息。

![picture1](/img/mongodb/cluster.svg)

### 分片的优势
读/写
MongoDB的分布在整个读取和写入负载 碎片的在分片集群，使每个碎片来处理群集操作的一个子集。通过添加更多分片，读取和写入工作负载都可以在集群中水平扩展。对于包含分片键或复合分片键前缀mongos的查询，可以将查询定位到特定分片或分片集。这些有针对性的操作通常比广播到集群中的每个分片更有效 。

存储容量
分片横跨分发数据碎片在集群中，允许每个碎片以包含总簇数据的子集。随着数据集的增长，额外的分片会增加集群的存储容量。

高可用性
将配置服务器和分片部署为副本集提供了更高的可用性。即使一个或多个分片副本集变得完全不可用，分片集群也可以继续执行部分读写。也就是说，虽然无法访问不可用分片上的数据，但针对可用分片的读取或写入仍然可以成功。

### 注意事项
分片集群基础设施要求和复杂性需要仔细规划、执行和维护。一旦集合被分片，MongoDB 不提供任何方法来取消分片集合的分片。

## 存储引擎

从MongoDB 3.2开始，WiredTiger存储引擎开始作为默认的存储引擎。

### 文档级别的并发

WiredTiger使用文档级并发控制进行写操作。 因此，多个客户端可以并发同时修改集合的不同文档。

对于大多数读写操作，WiredTiger使用乐观并发控制模式。 WiredTiger仅在全局、数据库和集合级别使用意向锁。 当存储引擎检测到两个操作之间存在冲突时，将引发写冲突，从而导致MongoDB自动重试该操作。

一些全局操作（通常是涉及多个数据库的短暂操作）仍然需要全局“实例范围级别的”锁。 其他一些操作（例如删除集合）仍然需要独占数据库锁。

### 快照与检查点

WiredTiger使用MultiVersion并发控制（MVCC）方式。 在操作开始时，WiredTiger为操作提供数据的时间点快照。 快照提供了内存数据的一致视图。

写入磁盘时，WiredTiger将所有数据文件中的快照中的所有数据以一致的方式写入磁盘。 现在持久的数据充当数据文件中的检查点。 该检查点可确保数据文件直到最后一个检查点（包括最后一个检查点）都保持一致； 即检查点可以充当恢复点。

从3.6版本开始，MongoDB配置WiredTiger以60秒的间隔创建检查点（即将快照数据写入磁盘）。 

在写入新检查点期间，先前的检查点仍然有效。 这样，即使MongoDB在写入新检查点时终止或遇到错误，重启后，MongoDB仍可从上一个有效检查点恢复。

当WiredTiger的元数据表被原子更新以引用新的检查点时，新的检查点将变为可访问且永久的。 一旦可以访问新的检查点，WiredTiger就会从旧的检查点释放页面。

使用WiredTiger，即使没有日志，MongoDB也可以从最后一个检查点恢复； 但是，要恢复上一个检查点之后所做的更改，请运行日志功能。

### 日志

WiredTiger将日志与检查点结合使用以确保数据持久性。

WiredTiger日志与保留检查点之间的所有数据修改。 如果MongoDB在检查点之间退出，它将使用日志获取自上一个检查点以来修改的所有数据。


参考文献
--

